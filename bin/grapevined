#!/usr/bin/env ruby

dir = File.dirname(File.expand_path(__FILE__))
$:.unshift(File.join(dir, '..', 'lib'))

require 'rubygems'
require 'daemons'
require 'grapevine'
require 'grapevine/setup'

# Catch CTRL-C and exit cleanly
trap("INT") do
  puts
  exit()
end

Daemons.run_proc('grapevined') do
  # Load configuration properties
  Grapevine::Config.load_file()

  # Create a registry of all loaders and notifiers
  registry = Grapevine::Registry.new()
  registry.load_config()
  
  Grapevine.log.debug("Loaders: #{registry.loaders.length}")
  Grapevine.log.debug("Notifiers: #{registry.notifiers.length}")

  loop do
    Grapevine.log.debug("===")
    
    # Run all registry loaders
    registry.loaders.each do |loader|
      loader.load()
    end

    # Run all registry notifiers
    registry.notifiers.each do |notifier|
      notifier.send()
    end

    sleep(30)
  end
end
